generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "sqlite"
}

model SystemMeta {
  key       String   @id
  value     String?
  createdAt DateTime @default(now()) @map("created_at")

  @@map("system_meta")
}

model StartupEvent {
  id        Int      @id @default(autoincrement())
  event     String?
  timestamp BigInt?

  @@map("startup_events")
}

// ============================================================================
// System Settings
// ============================================================================

model SystemSettings {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("system_settings")
}

// ============================================================================
// Agent Logging (Phase-0 ยง5.3)
// ============================================================================

model AgentLog {
  id        Int      @id @default(autoincrement())
  agentId   String   @map("agent_id")
  agentName String?  @map("agent_name")
  timestamp DateTime @default(now())
  provider  String?
  model     String?
  input     String?
  success   Boolean
  error     String?

  actions   AgentActionLog[]

  @@map("agent_logs")
}

model AgentActionLog {
  id        Int      @id @default(autoincrement())
  logId     Int      @map("log_id")
  type      String
  entityId  String   @map("entity_id")
  entityType String? @map("entity_type")
  before    String?
  after     String?

  log       AgentLog @relation(fields: [logId], references: [id], onDelete: Cascade)

  @@map("agent_action_logs")
}

// ============================================================================
// Notes & Collections (Phase-1)
// ============================================================================

model Note {
  id        String   @id @default(uuid())
  title     String
  content   String   // The source of truth for the note content
  metadata  String?  // JSON encoded metadata
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  placements NotePlacement[]
  categories Category[] 
  
  outgoingAssociations NoteAssociation[] @relation("source")
  incomingAssociations NoteAssociation[] @relation("target")

  @@map("notes")
}

model Collection {
  id        String   @id @default(uuid())
  name      String
  
  folders    Folder[]
  placements NotePlacement[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("collections")
}

model Folder {
  id           String      @id @default(uuid())
  name         String
  collection   Collection  @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  collectionId String      @map("collection_id")

  parent       Folder?     @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  parentId     String?     @map("parent_id")
  children     Folder[]    @relation("FolderHierarchy")

  placements   NotePlacement[]

  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("folders")
}

model NotePlacement {
  id           String     @id @default(uuid())
  note         Note       @relation(fields: [noteId], references: [id], onDelete: Cascade)
  noteId       String     @map("note_id")
  
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  collectionId String     @map("collection_id")
  
  folder       Folder?    @relation(fields: [folderId], references: [id], onDelete: Cascade)
  folderId     String?    @map("folder_id")

  @@unique([noteId, collectionId, folderId])
  
  @@map("note_placements")
}

model Category {
  id    String @id @default(uuid())
  name  String @unique
  
  notes Note[]

  @@map("categories")
}

model NoteAssociation {
  id        String  @id @default(uuid())
  source    Note    @relation("source", fields: [sourceId], references: [id], onDelete: Cascade)
  sourceId  String  @map("source_id")
  
  target    Note    @relation("target", fields: [targetId], references: [id], onDelete: Cascade)
  targetId  String  @map("target_id")

  type      String? // e.g. "relates_to", "blocks", etc.
  metadata  String? // JSON for future extensibility

  @@unique([sourceId, targetId])
  @@map("note_associations")
}

// ============================================================================
// AI Providers (Phase-1 AI Settings)
// ============================================================================

model AIProvider {
  id        String   @id
  name      String
  enabled   Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  config    AIProviderConfig?
  
  @@map("ai_providers")
}

model AIProviderConfig {
  id          String     @id @default(uuid())
  providerId  String     @unique @map("provider_id")
  configJson  String     @map("config_json")
  
  provider    AIProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  
  @@map("ai_provider_configs")
}

// ============================================================================
// Commands & Hotkeys (Command Palette Feature)
// ============================================================================

model Command {
  id            String   @id @default(uuid())
  name          String
  description   String?
  type          String   // 'navigation' | 'crud' | 'application' | 'agent'
  actionType    String   @map("action_type") // 'navigate' | 'execute' | 'toggle' | 'agent-execute'
  actionPayload String?  @map("action_payload") // JSON: { route?: string, agentId?: string, params?: any }
  enabled       Boolean  @default(true)
  isBuiltIn     Boolean  @default(false) @map("is_built_in")
  source        String   @default("system") // 'system' | 'user' | 'plugin'
  category      String?  // For grouping in UI (e.g., 'Navigation', 'Notes', 'AI')
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  hotkeys       CommandHotkey[]
  
  @@map("commands")
}

model CommandHotkey {
  id          String   @id @default(uuid())
  commandId   String   @map("command_id")
  accelerator String   // Electron accelerator format: 'CommandOrControl+Shift+P'
  isGlobal    Boolean  @default(false) @map("is_global")
  
  command     Command  @relation(fields: [commandId], references: [id], onDelete: Cascade)
  
  @@unique([accelerator]) // Prevent duplicate hotkey bindings
  @@map("command_hotkeys")
}
